# Maintainer: Brandon Boese <brandonboese@protonmail.com>
pkgname=lomiri-telephony-service
pkgver=0.5.2
pkgrel=0
pkgdesc="Backend dispatcher service for various mobile phone related operations"
url="https://gitlab.com/ubports/development/core/telephony-service"
arch="all"
license="GPL-3.0-only"
depends="lomiri qt5-qtbase qt5-qtdeclarative libphonenumber telepathy-qt telepathy-ofono lomiri-history-service"
makedepends="
	cmake
	qt5-qtbase-dev
	qt5-qtdeclarative-dev
	qt5-qtdeclarative
	qt5-qtpim-dev
	qt5-qtmultimedia-dev
	qt5-qtfeedback-dev
	lomiri-api-dev
	lomiri-history-service
	lomiri-url-dispatcher-dev
	libusermetrics-dev
	libqtdbustest
	libphonenumber-dev
	telepathy-qt-dev
	pulseaudio-dev
	ayatana-indicator-messages-dev
	libnotify-dev
	dconf
	"
checkdepends="qt5-qtbase-dev qt5-qtdeclarative-dev qt5-qtquickcontrols2-dev"
source="telephony-service-$pkgver.tar.gz::https://gitlab.com/ubports/development/core/telephony-service/-/archive/$pkgver/telephony-service-$pkgver.tar.gz
	fix-tests-failing-to-generate.patch
	"
builddir="$srcdir/telephony-service-$pkgver"

build() {
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_SYSCONFDIR=/etc \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var \
		-DSKIP_QML_TESTS=ON
	make -C build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	make -C build DESTDIR="$pkgdir" install
}

sha512sums="
c51fe3bf1db6374e256e48087eca6ffeb1e827162118e1868c21340e50e8eed3a61a5c3b39bb0a04b3a8a046e029ab6a72cdb901e958d964df5714577fc22015  telephony-service-0.5.2.tar.gz
c50dd81603a91ed0898cc353d564b224dc90cd798ee8c47c41e023fea8a212253072781eb94fe50f77cdf5ce54d948cd565ac57caf7ac9e81530b68b287299ea  fix-tests-failing-to-generate.patch
"
