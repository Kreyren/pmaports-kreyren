# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20230605
_commit="8a2f908c306ec63a7a0f14c247fa1676c655c7ce"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/development/core/lomiri"
license="GPL-3.0 LGPL-2.1"
# FIXME add maliit-keyboard
depends="
	ayatana-indicator-keyboard
	ayatana-indicator-session
	gsettings-desktop-schemas
	lomiri-schemas
	lomiri-settings-components
	lomiri-system-compositor
	openrc-settingsd
	qt5-qtbase-sqlite
	qt5-qtgraphicaleffects
	suru-icon-theme
	"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock lomiri-indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev elogind-dev qtmir-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/development/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-Add-missing-includes.patch
	0002-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0003-Link-against-libintl.patch
	0004-No-systemd.patch
	0005-fixups.patch
	"
subpackages="$pkgname-lang indicators-client:indicators_client"
builddir="$srcdir/$pkgname-$_commit"
options="!check" # Tests fail

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel.1/
}

indicators_client() {
	pkgdesc="Indicators client test application"
	amove usr/bin/indicators-client
	amove usr/share/applications/indicators-client.desktop
}

sha512sums="
0fe3a78c386607c5d4f536b2af7c172275cabe568f7c229d3a622ea197a49da7c8c48ac2f293d593e43602326528e95b88d914cedb60ddd056942cda9d64504c  lomiri-8a2f908c306ec63a7a0f14c247fa1676c655c7ce.tar.gz
4786b0d23012a1dcb679d2b44ea843a0db8dfebc58fb45f5556bfb8ac5506e85ecb210678543ab0e62477769ee6cd0946edb4a536d343d9baca8e569b5707982  0001-Add-missing-includes.patch
2894f254155b1b62369cbdeb3e48ce900a7fd67b63126a62633516c31f39d33348ca357509ec1722aa48f4b35f7f20654fbe45f8f59b324cb5c223957effd334  0002-Add-qt5-suffix-to-search-for-Qt-tools.patch
5ad97ebb32c0df25c03ebc9245430f7bf84fd1d90f1aebbaaf0cc48dca7fe3bda6c4c86ed146366ab3fc653d7ddab66d645f06fba16fe25f86eeb880bb883d1d  0003-Link-against-libintl.patch
198bab4c275f0397f67a3307aa71dc504378d3a54f2c98775ef450240c41b22b24d14fbd82df8ed902b24fe7d24a1b7cf8ca5f44fbf9f0a9575d9be5fdc4cd65  0004-No-systemd.patch
d87826f163af0155b5fdbac0c93534430573dbcbbd294b6a71e36b4db2d93c87739d9d43fdb826f27b2469c767eaa2b491e7823cd449bc421e615d4ec997c36a  0005-fixups.patch
"
