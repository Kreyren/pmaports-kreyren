# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0.1.4
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all !armhf"
url="https://gitlab.com/ubports/development/core/lomiri"
license="GPL-3.0-only AND LGPL-2.1-only"
depends="
	ayatana-indicator-keyboard
	ayatana-indicator-session
	gsettings-desktop-schemas
	lomiri-schemas
	lomiri-settings-components
	openrc-settingsd
	qt5-qtbase-sqlite
	qt5-qtgraphicaleffects
	suru-icon-theme
	"
makedepends="
	cmake
	cmake-extras
	dbus-test-runner
	doxygen
	elogind-dev
	geonames-dev
	gnome-desktop-dev
	graphviz
	gsettings-qt-dev
	libqtdbusmock
	libqtdbustest
	linux-pam-dev
	lomiri-api-dev
	lomiri-app-launch-dev
	lomiri-deviceinfo-dev
	lomiri-download-manager-dev
	lomiri-indicator-network-dev
	lomiri-libusermetrics-dev
	lomiri-system-settings
	lomiri-ui-toolkit-dev
	qmenumodel
	qmenumodel-dev
	qt5-qtbase-dev
	qt5-qtdeclarative-dev
	qtmir-dev
	samurai
	"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/development/core/lomiri/-/archive/$pkgver/lomiri-$pkgver.tar.gz
	0001-Add-support-for-both-older-qtmir-and-newer-qtmir-wit.patch
	0002-cursor-Always-follow-cursor-position-from-mir.patch
	0003-Add-missing-includes.patch
	0004-Link-against-libintl.patch
	0005-Compile-with-C-17.patch
	0006-Use-correct-value-for-Leds.state.patch
	0007-Disable-broken-tests-due-to-dropped-mocks-from-mir-2.patch
	0008-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0009-No-systemd.patch
	0010-Disable-lightdm-integration.patch
	"
subpackages="$pkgname-lang indicators-client:indicators_client"
options="!check" # Tests fail

build() {
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var \
		-DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_TYPE=None
	cmake --build build
}

check() {
	ctest --test-dir build --output-on-failure
}

package() {
	DESTDIR="$pkgdir" cmake --install build
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel.1/
}

indicators_client() {
	pkgdesc="Indicators client test application"
	amove usr/bin/indicators-client
	amove usr/share/applications/indicators-client.desktop
}

sha512sums="
9a6991a1008a0679de16047e1e536466f863a63116de6948d89324b7ef309677c034d20250c5d6de70cf28e414ff0db792b54c47cb3f694b9dbf8828fedbedeb  lomiri-0.1.4.tar.gz
95da99b4ccbfeea17e115be19b84da373067368ed3db54079e4be48f9c085172ac851538fcef73eaa66747597ce3603c18e99480c2ae14c030bee390f28c3921  0001-Add-support-for-both-older-qtmir-and-newer-qtmir-wit.patch
cf5b6fe3fda6078f436b8b4bf937987b43271b197fade1d8791960cde81248b173ccc475a36aecec9dac600701c6d7366d8f44946aafbe837049861814811dbb  0002-cursor-Always-follow-cursor-position-from-mir.patch
658557fe0fa873b7d075c5f83343047ee69b5552af2e6dfd544f30da8c4bc27d6dba1267f8d018c29263604be62a043f77f88ca689aefc21fbe5a7553f5ddf7c  0003-Add-missing-includes.patch
8e38e442c62a2b8b77c28245ad22b2656dd09b6c2df58996841f19edc7ce94914c88cbee5e1028ea4f012810da9267d13494d1ab429448ebf8692b7a2a541106  0004-Link-against-libintl.patch
e9ff7e74fa2641092b56b6f5c87eef71d15514be452ba2c8fa39acc3b6cc4c29105e1db6375d8add4dba9e0f5c9afeeab74b26f504955d929dcefa82c20fec7b  0005-Compile-with-C-17.patch
7655f760c0a396d2a8f8c8e2b4f737f1452c93214e438a566f291389972c58be7e2b7f8710f3aadfd482d5b9d6705507beb5715989cacfea92f752e59afce6dd  0006-Use-correct-value-for-Leds.state.patch
c8a2c169e79f0bd473273a5273ff06e9c8ec6f53d802dbc8a27f1c2d7a23d9d983df61fa0af387f5d6efc423e730326339a992740778c5227f06fe37d18008fb  0007-Disable-broken-tests-due-to-dropped-mocks-from-mir-2.patch
ec43307cfe885efaddfd3d9a167ec4a0332bedbe49e5bc57801124c0eae24b1a067a4d12458ec8b129b7e7cf3a589683c6afae730c081ae55fe4c4714163cbc3  0008-Add-qt5-suffix-to-search-for-Qt-tools.patch
b0194896788a8be4b105922e9a1ead6a1e7c828676c439baa23a4a7aacaa9756fccd383491a784629b7ee8bf0b9e0e0e46c482ca0da84317034142e71b4a760e  0009-No-systemd.patch
2fd9be535b0b7784d8d850adb7cf98d4b5396ebf7aa8ca9832f7855f48b442eef7d25a2c9c07fb505e923ac246a1cc48fceaf1b004e691c1ad56e461a61471c3  0010-Disable-lightdm-integration.patch
"
