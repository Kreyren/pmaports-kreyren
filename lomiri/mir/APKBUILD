# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=mir
pkgver=1.8.2
pkgrel=0
pkgdesc="Mir Display Server"
url="https://mir-server.io"
arch="all"
license="GPL-2.0-or-later AND LGPL-2.0-or-later"
depends="xkeyboard-config ttf-freefont"
depends_dev="boost-dev mesa-dev glm-dev glog-dev gflags-dev eudev-dev glib-dev wayland-dev libepoxy-dev nettle-dev libinput-dev
	capnproto-dev libxml++-2.6-dev py3-pillow freetype-dev libevdev-dev umockdev-dev lttng-ust-dev yaml-cpp-dev libxcursor-dev"
makedepends="$depends_dev cmake lttng-ust-tools libxkbcommon-dev gtest-dev gmock wlcs-dev protobuf-dev"
checkdepends="wlcs grep bash"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/MirServer/mir/archive/v$pkgver.tar.gz
	0001-Stop-forcing-systemtap-integration.patch
	0002-Add-possibility-to-force-kms-device.patch
	0003-Work-around-capnproto-incompatibility.patch
	0004-Fix-Alpine-edge-by-not-using-internal-GTEST-macros-f.patch
	0005-Fix-compilation-failure-with-GCC-12-missing-headers.patch
	0006-Update-logind-session.xml-from-latest-systemd.patch
	0007-Regenerate-logind-session.-files.patch
	0008-Set-the-logind-session-type.patch
	0009-Add-missing-headers.patch
"
subpackages="$pkgname-dev $pkgname-demos $pkgname-test-tools:test_tools"
options="!check" # Some tests fail

build() {
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DMIR_FATAL_COMPILE_WARNINGS=OFF \
		-DMIR_USE_LD=ld
	make -C build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	make -C build DESTDIR="$pkgdir" install
}

demos() {
	pkgdesc="$pkgdesc - demonstration programs"
	amove usr/bin/miral-shell
	amove usr/bin/miral-kiosk
	amove usr/bin/miral-app
	amove usr/bin/miral-terminal
	amove usr/bin/mir-shell
	amove usr/bin/miral-system-compositor
	amove usr/share/applications/miral-shell.desktop
	amove usr/share/wayland-sessions/mir-shell.desktop
	amove usr/share/icons/hicolor/scalable/apps/ubuntu-logo.svg
}

test_tools() {
	pkgdesc="$pkgdesc - stress tests and other test tools"
	amove usr/bin/mir_stress
	amove usr/bin/mir_performance_tests
	amove usr/bin/mir-smoke-test-runner
	amove usr/bin/mir_platform_graphics_test_harness
	amove usr/lib/mir/tools/libmirclientlttng.so
	amove usr/lib/mir/tools/libmirserverlttng.so
	amove usr/bin/mir_demo_client_*
	amove usr/bin/mir_demo_server
	amove usr/lib/mir/server-platform/graphics-dummy.so
	amove usr/lib/mir/server-platform/input-stub.so
	amove usr/lib/mir/client-platform/dummy.so
	amove usr/lib/mir/miral_wlcs_integration.so
}

sha512sums="
7d2da696b77a9fe470ea726cfe3788c192ecc81921ce355f68ca37616bbaad8f4f3402ad7320fab371ff944f5f27bc210d5e640a00c15e3651f1d1e084715bae  mir-1.8.2.tar.gz
1bf8e471f40e899a7279566730b99b16950374447d0af6beaaf17a9b9c28a083bd9e6919d900d82d08220daa4b66246abeeee5f4d308a8f2b494117918783775  0001-Stop-forcing-systemtap-integration.patch
cca5a779f0f42f87ffcede06d852ceeca01dfc10b3f2265ff7f6cb59c8e52bdd9128e1fe58c2d8cffd2197f45816d3ca0ef85aaaf9a9874a403af0438b21c450  0002-Add-possibility-to-force-kms-device.patch
faebabcbfbbb07c2e669db0c12eea97f0f90068e5a8b82e79d4f81c8fbbf7e989ad77a2406f938d35e71ff235798f4c0ccfbe8216da22b277bb0e508a728d478  0003-Work-around-capnproto-incompatibility.patch
741110357bec8fb5ed208465792ad7c3ccff8b45a65123ed244a24c14f1b4054c31e8f54d6452b00e1512c70c808440af8fe3f148cab3ff83bdd50f18e8090b8  0004-Fix-Alpine-edge-by-not-using-internal-GTEST-macros-f.patch
10ef02c95f0da32c0f3056539c319442cb67c4a7e507d0c8314d21cdaee28f0e7665da20cd94e8170e454ff0873c5d59f31294cf2adfbfd47766e681cee8fbf1  0005-Fix-compilation-failure-with-GCC-12-missing-headers.patch
3823f7de92d88a661572280194d89554bd7bf6dea4c5c61e3782cc43bd6f8557a6ee895c7f7e96a0c6722407c632c242ccd7608371a779cc9bfa2d7a8ce26b37  0006-Update-logind-session.xml-from-latest-systemd.patch
7ffff30eae1c0c0b02cb00f762d5ec9f37d949dab01e22545f854877a82d9200d50106b59977b34e2d377ba0de202f649ba95b232f81c37c33d68ce9dd4b86ee  0007-Regenerate-logind-session.-files.patch
50dd8f87b6e1b594361542cd2522745b2c190262edbb6397cf0da39a5f45223e5e86d98da732cf4a546ce14b5cae2621a4b5970453f79d505070366dbdebbadf  0008-Set-the-logind-session-type.patch
d2567cb42ae445d9ebd2e63b25d1a7db53f1523980d643227e1280bb68bbaa66607400a9658782329c33a06dd570303606703a0187140a15a8959c0d653db512  0009-Add-missing-headers.patch
"
