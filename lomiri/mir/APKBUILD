# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=mir
pkgver=1.8.2
pkgrel=0
pkgdesc="Mir Display Server"
url="https://mir-server.io"
arch="all"
license="GPL-2.0-or-later AND LGPL-2.0-or-later"
depends="xkeyboard-config ttf-freefont"
depends_dev="boost-dev mesa-dev glm-dev glog-dev gflags-dev eudev-dev glib-dev wayland-dev libepoxy-dev nettle-dev libinput-dev
	capnproto-dev libxml++-2.6-dev py3-pillow freetype-dev libevdev-dev umockdev-dev lttng-ust-dev yaml-cpp-dev libxcursor-dev"
makedepends="$depends_dev cmake lttng-ust-tools libxkbcommon-dev gtest-dev gmock wlcs-dev protobuf-dev"
checkdepends="wlcs grep bash"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/MirServer/mir/archive/v$pkgver.tar.gz
	0001-Stop-forcing-systemtap-integration.patch
	0002-Add-possibility-to-force-kms-device.patch
	0003-Work-around-capnproto-incompatibility.patch
	0004-Fix-Alpine-edge-by-not-using-internal-GTEST-macros-f.patch
	0005-Fix-compilation-failure-with-GCC-12-missing-headers.patch
	0006-Update-logind-session.xml-from-latest-systemd.patch
	0007-Regenerate-logind-session.-files.patch
	0008-Set-the-logind-session-type.patch
"
subpackages="$pkgname-dev $pkgname-demos $pkgname-test-tools:test_tools"
options="!check" # Some tests fail

build() {
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DMIR_FATAL_COMPILE_WARNINGS=OFF \
		-DMIR_USE_LD=ld
	make -C build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	make -C build DESTDIR="$pkgdir" install
}

demos() {
	pkgdesc="$pkgdesc - demonstration programs"
	amove usr/bin/miral-shell
	amove usr/bin/miral-kiosk
	amove usr/bin/miral-app
	amove usr/bin/miral-terminal
	amove usr/bin/mir-shell
	amove usr/bin/miral-system-compositor
	amove usr/share/applications/miral-shell.desktop
	amove usr/share/wayland-sessions/mir-shell.desktop
	amove usr/share/icons/hicolor/scalable/apps/ubuntu-logo.svg
}

test_tools() {
	pkgdesc="$pkgdesc - stress tests and other test tools"
	amove usr/bin/mir_stress
	amove usr/bin/mir_performance_tests
	amove usr/bin/mir-smoke-test-runner
	amove usr/bin/mir_platform_graphics_test_harness
	amove usr/lib/mir/tools/libmirclientlttng.so
	amove usr/lib/mir/tools/libmirserverlttng.so
	amove usr/bin/mir_demo_client_*
	amove usr/bin/mir_demo_server
	amove usr/lib/mir/server-platform/graphics-dummy.so
	amove usr/lib/mir/server-platform/input-stub.so
	amove usr/lib/mir/client-platform/dummy.so
	amove usr/lib/mir/miral_wlcs_integration.so
}

sha512sums="
7d2da696b77a9fe470ea726cfe3788c192ecc81921ce355f68ca37616bbaad8f4f3402ad7320fab371ff944f5f27bc210d5e640a00c15e3651f1d1e084715bae  mir-1.8.2.tar.gz
83905da8192f4eda5494d69dd9ea823a5efb22d8bc05a01c42159a07bbc432f13a2ec8db3a8a380d5e500da20c2f1f380e20f4d54117a14a43bd3829dfbcc0e8  0001-Stop-forcing-systemtap-integration.patch
dab2de70c4d6722fbabb4e1ff4c3150ce892a3540b93d5776384cc021cd215e2b5cebdb57f3ddea9a0df3f00339dd3d9a4397a9cc15bd76546de2571c46a8936  0002-Add-possibility-to-force-kms-device.patch
d719eb97febd018a9ac9738675549bd633be59b2a08bf9aa74a2c6c9f810c093052abcb94295cf2bb26a73471d543281c341f148c4c320b90e44a8001e5dda09  0003-Work-around-capnproto-incompatibility.patch
0bdb0b918fa285c0380516d0e03fb9fe460288dc896a4ac12afdbe4e200c6f92eb3153365862d8499cbb6a57caf5231ffd96746d783f7dc3744f1fa95e79bb30  0004-Fix-Alpine-edge-by-not-using-internal-GTEST-macros-f.patch
f2007d76012c28e55f07dc488c625611075952b2dbce9d1ca29731b33bed78b714cd9f079ccd8e5638fc2d68e783a269444d9d903c74cfe887c4e7dfec79b88c  0005-Fix-compilation-failure-with-GCC-12-missing-headers.patch
dcbf64e31435566738f7a5163b5070197834a01f8b98e3a783e3b36092206749b99230ff2804213db4ee967e0c7da71b63e25f54120477ce1aeb88d5094f0e61  0006-Update-logind-session.xml-from-latest-systemd.patch
cc64addd80571cf7dcba1adbbe2086da2e75850809cef54e37d1059dc011440fc1579ff05eca8d87cec6d37170c44cb2a4a30e273fec0306290823f5be7a14b2  0007-Regenerate-logind-session.-files.patch
16b3d8f1ad183da7af5fd2c0b4af0c2bd1dd3d9159274ab91079d94d8ce760adab32dffc93469b635678538b7e7dcc4e423f635e0931914e0aa8d3003d0a7a2c  0008-Set-the-logind-session-type.patch
"
