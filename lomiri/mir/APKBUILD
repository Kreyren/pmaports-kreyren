# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=mir
pkgver=1.8.2
pkgrel=0
pkgdesc="Mir Display Server"
url="https://mir-server.io"
arch="all"
license="GPL-2.0-or-later AND LGPL-2.0-or-later"
depends="xkeyboard-config ttf-freefont"
depends_dev="boost-dev mesa-dev glm-dev glog-dev gflags-dev eudev-dev glib-dev wayland-dev libepoxy-dev nettle-dev libinput-dev
	capnproto-dev libxml++-2.6-dev py3-pillow freetype-dev libevdev-dev umockdev-dev lttng-ust-dev yaml-cpp-dev libxcursor-dev"
makedepends="$depends_dev cmake lttng-ust-tools libxkbcommon-dev gtest-dev gmock wlcs-dev protobuf-dev"
checkdepends="wlcs grep bash"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/MirServer/mir/archive/v$pkgver.tar.gz
	0001-Stop-forcing-systemtap-integration.patch
	0002-Add-possibility-to-force-kms-device.patch
	0003-Work-around-capnproto-incompatibility.patch
	0004-Fix-Alpine-edge-by-not-using-internal-GTEST-macros-f.patch
	0005-Fix-compilation-failure-with-GCC-12-missing-headers.patch
	0006-Update-logind-session.xml-from-latest-systemd.patch
	0007-Regenerate-logind-session.-files.patch
	0008-Set-the-logind-session-type.patch
	0009-Add-missing-headers.patch
	0010-Build-with-C-17-to-fix-protobuf-error.patch
	0011-Mark-operator-function-as-const-to-fix-with-C-17.patch
	0012-Fix-gtest-pkg-config-detection.patch
"
subpackages="$pkgname-dev $pkgname-demos $pkgname-test-tools:test_tools"
options="!check" # Some tests fail

build() {
	# Try to resolve linker errors with protobuf+abseil-cpp
	export LDFLAGS="$LDFLAGS -Wl,--copy-dt-needed-entries"
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DMIR_FATAL_COMPILE_WARNINGS=OFF \
		-DMIR_USE_LD=ld
	make -C build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	make -C build DESTDIR="$pkgdir" install
}

demos() {
	pkgdesc="$pkgdesc - demonstration programs"
	amove usr/bin/miral-shell
	amove usr/bin/miral-kiosk
	amove usr/bin/miral-app
	amove usr/bin/miral-terminal
	amove usr/bin/mir-shell
	amove usr/bin/miral-system-compositor
	amove usr/share/applications/miral-shell.desktop
	amove usr/share/wayland-sessions/mir-shell.desktop
	amove usr/share/icons/hicolor/scalable/apps/ubuntu-logo.svg
}

test_tools() {
	pkgdesc="$pkgdesc - stress tests and other test tools"
	amove usr/bin/mir_stress
	amove usr/bin/mir_performance_tests
	amove usr/bin/mir-smoke-test-runner
	amove usr/bin/mir_platform_graphics_test_harness
	amove usr/lib/mir/tools/libmirclientlttng.so
	amove usr/lib/mir/tools/libmirserverlttng.so
	amove usr/bin/mir_demo_client_*
	amove usr/bin/mir_demo_server
	amove usr/lib/mir/server-platform/graphics-dummy.so
	amove usr/lib/mir/server-platform/input-stub.so
	amove usr/lib/mir/client-platform/dummy.so
	amove usr/lib/mir/miral_wlcs_integration.so
}

sha512sums="
7d2da696b77a9fe470ea726cfe3788c192ecc81921ce355f68ca37616bbaad8f4f3402ad7320fab371ff944f5f27bc210d5e640a00c15e3651f1d1e084715bae  mir-1.8.2.tar.gz
8297617b1d101bf04d00c3f8a5e49d9154254e1335cea4179310ad22a41968e55a13e0f18eaaad51c85467b1b6868454774e4832fe2670de83c77b3288faaa14  0001-Stop-forcing-systemtap-integration.patch
637cf36599f697dd8611d35e29984d61e7cc1c7729f8c8e72528db378e0ece91426db64b98f243b3a078d50bd636b839837f12ec332e2d8b2ca0dc275c6eff2d  0002-Add-possibility-to-force-kms-device.patch
64e4c8aa2d7eb215aa1fc7cecfbfdf33c26113285c0aa255f411d596637458abfa3b5b598a2b90e791266ba7716fbf98ff7f000ccbf9d5a85b08d0e793a6e968  0003-Work-around-capnproto-incompatibility.patch
0e25d1a02d12f4802e8a220a79e13ca07181f1385d2d6ee6cb2ac3efd4c0ab53542ba5d89a1a5fe2eb9ef7a6b05e9b25bebda03036f59364f5842230c29c6a98  0004-Fix-Alpine-edge-by-not-using-internal-GTEST-macros-f.patch
aadde710b19ebe7f35d7b031d2d78411052c7249524c646c2f945f9a18e92eb77f66e532c208ee5d2986d5114480ebd488491919381a522d73408007f7dd547b  0005-Fix-compilation-failure-with-GCC-12-missing-headers.patch
8243b74219c63b00f82358124bc72f308f8123a3824c1288892fef20c33f0bd733464110d52f3a3fe1bd0d43301ee0a1e4bfd900ad98a73c4b4fdb7fdcd432ae  0006-Update-logind-session.xml-from-latest-systemd.patch
3efef80bc1eb874cb89662f0fabc4aef2781c5962f9effb4161d449dfe11f7d8527cd6d53d22070330e9a9dc989697954c937ebcc19d2491a91eacc9829d2dd3  0007-Regenerate-logind-session.-files.patch
f8886b78790349b3a748e01124346af26d2a808d4c232166bedf9a785f56b4b51b18a421e975554fd00058aecc0dd2e3371fb3d74463c1e3ed253a5154ffe1d8  0008-Set-the-logind-session-type.patch
7bf4276b95ffec08d4542a605cf2d4cd3ab15fc29e6434372ad0ff40db1f96b2b7cecc3ab8b608ee189185ae1d771db0e8e4300555fd0877dd651f85703395f7  0009-Add-missing-headers.patch
dc81678eb00d669e4fe0963844ced84d49f4e4163cf71d23fa533cade851d6e5485b83dde960a6254d30f735631cc76989770d41fef9855e97096797ce911e42  0010-Build-with-C-17-to-fix-protobuf-error.patch
c0e5b03c761d867b171ca4b45269248566942c4d789780d95cb0dd8dd0e5045fd3c952a6ef8c7666c9cff85cda8490c06e1fa7dadc2116e1586cdb65627dea66  0011-Mark-operator-function-as-const-to-fix-with-C-17.patch
f74f9c6217ffd9c6d2b98fbeaa8169b953100fd304a464f4bc535f77feb04201daf4124b9c7d459175e0a5ddbcfcf5f89769625180b046cd97443b0e5eae61bf  0012-Fix-gtest-pkg-config-detection.patch
"
