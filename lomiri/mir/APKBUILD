# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=mir
pkgver=1.8.2
pkgrel=0
pkgdesc="Mir Display Server"
url="https://mir-server.io"
arch="all"
license="GPL-2.0-or-later AND LGPL-2.0-or-later"
depends="xkeyboard-config ttf-freefont"
depends_dev="boost-dev mesa-dev glm-dev glog-dev gflags-dev eudev-dev glib-dev wayland-dev libepoxy-dev nettle-dev libinput-dev
	capnproto-dev libxml++-2.6-dev py3-pillow freetype-dev libevdev-dev umockdev-dev lttng-ust-dev yaml-cpp-dev libxcursor-dev"
makedepends="$depends_dev cmake lttng-ust-tools libxkbcommon-dev gtest-dev gmock wlcs-dev protobuf-dev"
checkdepends="wlcs grep bash"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/MirServer/mir/archive/v$pkgver.tar.gz
	0001-Stop-forcing-systemtap-integration.patch
	0002-Add-possibility-to-force-kms-device.patch
	0003-Work-around-capnproto-incompatibility.patch
	0004-Fix-Alpine-edge-by-not-using-internal-GTEST-macros-f.patch
	0005-Fix-compilation-failure-with-GCC-12-missing-headers.patch
	0006-Update-logind-session.xml-from-latest-systemd.patch
	0007-Regenerate-logind-session.-files.patch
	0008-Set-the-logind-session-type.patch
	0009-Add-missing-headers.patch
	0010-Build-with-C-17-to-fix-protobuf-error.patch
	0011-Mark-operator-function-as-const-to-fix-with-C-17.patch
"
subpackages="$pkgname-dev $pkgname-demos $pkgname-test-tools:test_tools"
options="!check" # Some tests fail

build() {
	# Try to resolve linker errors with protobuf+abseil-cpp
	export LDFLAGS="$LDFLAGS -Wl,--copy-dt-needed-entries"
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DMIR_FATAL_COMPILE_WARNINGS=OFF \
		-DMIR_USE_LD=ld
	make -C build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	make -C build DESTDIR="$pkgdir" install
}

demos() {
	pkgdesc="$pkgdesc - demonstration programs"
	amove usr/bin/miral-shell
	amove usr/bin/miral-kiosk
	amove usr/bin/miral-app
	amove usr/bin/miral-terminal
	amove usr/bin/mir-shell
	amove usr/bin/miral-system-compositor
	amove usr/share/applications/miral-shell.desktop
	amove usr/share/wayland-sessions/mir-shell.desktop
	amove usr/share/icons/hicolor/scalable/apps/ubuntu-logo.svg
}

test_tools() {
	pkgdesc="$pkgdesc - stress tests and other test tools"
	amove usr/bin/mir_stress
	amove usr/bin/mir_performance_tests
	amove usr/bin/mir-smoke-test-runner
	amove usr/bin/mir_platform_graphics_test_harness
	amove usr/lib/mir/tools/libmirclientlttng.so
	amove usr/lib/mir/tools/libmirserverlttng.so
	amove usr/bin/mir_demo_client_*
	amove usr/bin/mir_demo_server
	amove usr/lib/mir/server-platform/graphics-dummy.so
	amove usr/lib/mir/server-platform/input-stub.so
	amove usr/lib/mir/client-platform/dummy.so
	amove usr/lib/mir/miral_wlcs_integration.so
}

sha512sums="
7d2da696b77a9fe470ea726cfe3788c192ecc81921ce355f68ca37616bbaad8f4f3402ad7320fab371ff944f5f27bc210d5e640a00c15e3651f1d1e084715bae  mir-1.8.2.tar.gz
bb465b7c484851a424c1b7de306c13d7f0b18130a341e1cb15f7eb579dc039ac4d0cca9524d766975d0bb003f76029dd67784b6bdf3113b2bd2342a1b68892e2  0001-Stop-forcing-systemtap-integration.patch
5221415887df887ebf57c4248222fb0db93b31cce2d48ca0476fe3a04d2b8329b42dac268afabc447d14a4f6ce78be337252cfdf11bcdbec9de1bbf54da53984  0002-Add-possibility-to-force-kms-device.patch
e97e86c9da9ef746e620d0df27e985c1e5e4ffa6b4c396a16087af63fd44d6496e29c542916d17bae1faabc71122a2ee90e76399be4eacd37596ede54afe1bae  0003-Work-around-capnproto-incompatibility.patch
0dc8ef72d000ed70003de9804f045177131521750001038d3c4bf01e18ea989232742b1900cb517153691f7aa5f7da8ced0774bd24374478282bcced911c8adb  0004-Fix-Alpine-edge-by-not-using-internal-GTEST-macros-f.patch
f1d0eabf4a5b403829cbab36bad48dd957763919be54f5cd5061ad7dd9672faa13ed96132a7073ae3751fa9ae6e607d31842a21041a62ea665a5fdd92fa2520d  0005-Fix-compilation-failure-with-GCC-12-missing-headers.patch
b05399bf50e582efc73f3dfde2740ff2216666ad9cfca1ebfb072f2312635c3424700d86f8c384f5b7650154bb4c62fcbf82107bd70567d371f61ab61d1c2d40  0006-Update-logind-session.xml-from-latest-systemd.patch
4a7cdd346f17580a033a9d3f4265af322f01c9e16e70e1b1ba754f860a4495d6da7fe6e2274cf2f3d3a9432a1b82379a2c1a5299d4a16c85f578335403bca5e3  0007-Regenerate-logind-session.-files.patch
bb389708871e17aaecf75899c8861442fae62642eec743b726f9f23d1f50677946f4e078791e74d3acf0d31d3d61c85d1e4f7752d4a8dc8d0ad81bd0fc8a1f7b  0008-Set-the-logind-session-type.patch
df8d9e2ff070ff8a38ae9ae32b49fdf90039c7c782768ba8732c6c96d960472c5298e5b0dcb877ba019970d81ff36da84e81c015b219b951481980578cb627fe  0009-Add-missing-headers.patch
db67fc799e75d300377116b9e75ba129e001fad9a32e632e57a42d1828a6819d5ae2234cdbc42c97416145b1dcce9ff7e46632a38af9ef412ea69c49d4c68436  0010-Build-with-C-17-to-fix-protobuf-error.patch
47132adf66af4a35895532e82b451da2986325f18dfa75161d9a5746a2df992a66131b6741c43eeda2ce25a53e4dc2c77ebe51fcb623084bed418af3034ab12b  0011-Mark-operator-function-as-const-to-fix-with-C-17.patch
"
