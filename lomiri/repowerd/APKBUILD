# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=repowerd
pkgver=2022.01_git20230608
pkgrel=0
_commit="7559c26a82e686a60df458490f60d266426928e0"
pkgdesc="Power daemon to monitor and control system power state"
url="https://gitlab.com/ubports/development/core/repowerd"
arch="all"
license="LGPL-3.0-only"
makedepends="cmake cmake-extras lomiri-deviceinfo-dev glib-dev gtest-dev gmock qt5-qtbase-dev libgbinder-dev"
checkdepends="dbus"
subpackages="$pkgname-openrc"
source="https://gitlab.com/ubports/development/core/repowerd/-/archive/$_commit/repowerd-$_commit.tar.gz
	repowerd.initd
	0001-Add-more-missing-headers.patch
	"
builddir="$srcdir/repowerd-$_commit"

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=None \
		-DREPOWERD_ENABLE_HYBRIS=False \
		$CMAKE_CROSSOPTS
	cmake --build build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
}

sha512sums="
38b584bea3cec8170932a38fa9da1769f844b8bc5e1c41466392b14e2eebb05969ba49f0681af436ba8d8883243c04a14d3add4c73a9aa88e108327f31f6afc2  repowerd-7559c26a82e686a60df458490f60d266426928e0.tar.gz
d8c4dd351a7bf2bcc66b0eb8b0d17d602661f7defb857be5a28f694e4977b634b7d101f738058ce0ccaa313c4e316f7222c753610500ddbd68f8e42de7c57f29  repowerd.initd
65c347c2bbdf4654b41491ce457d64fab77fc0ee3ababe4184a98b5dbaf08e81f1c0cbb33891971e98c293972c3a2286cec3a433f02e563ac64c07ef6bb33528  0001-Add-more-missing-headers.patch
"
