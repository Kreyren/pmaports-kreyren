# Maintainer: Brandon Boese <brandonboese@protonmail.com>
pkgname=lomiri-history-service
pkgver=0.4
pkgrel=0
pkgdesc="Service that provides call log and conversation history"
url="https://gitlab.com/ubports/development/core/history-service"
arch="all !armhf"
license="GPL-3.0-only"
depends="
	dconf
	qt5-qtbase-sqlite
	telepathy-mission-control
	"
makedepends="
	cmake
	cmake-extras
	libphonenumber-dev
	libqtdbustest
	qt5-qtbase-dev
	qt5-qtdeclarative-dev
	qt5-qtpim-dev
	sqlite-dev
	telepathy-qt-dev
	"
checkdepends="
	dbus-test-runner
	xvfb-run
	"
subpackages="$pkgname-dev"
source="https://gitlab.com/ubports/development/core/history-service/-/archive/$pkgver/history-service-$pkgver.tar.gz
	remove-systemd-dependency.patch
	werror-option.patch
	remove-daemon-directory.patch
	upgrade-to-CXX-17.patch
	"
options="!check" # TODO: Several tests timing out
builddir="$srcdir/history-service-$pkgver"

build() {
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_SYSCONFDIR=/etc \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var \
		-DENABLE_WERROR=OFF
	cmake --build build
}

check() {
	ctest --test-dir build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
73188367eb492375b1613ad10f45efd37b23cc0017955a12a89c375716268bb8bf1ba5ef024fae9798646312d3125d551549ffe44ad6c6e34fde60ba6d20fb42  history-service-0.4.tar.gz
4e5d0851623267860042a4cc8bf4e6e462da23ccac0cf739a3f2e1bed8de7cdde50c418dfe02a57018bfcb6b9b16af131ee04e5ca1b80b069e303cd9f0d0ef3f  remove-systemd-dependency.patch
5127f41033f4cd25bf89a2c19e6aea413501056548d8ba4a33cb5da2b0344f69a605cea3317fb7c13aa3ad2f1cc54bdeafbb0bba5cdc0045147779dcd2af272c  werror-option.patch
9df5f5f6f6e272f0734f82a34ffc201f3138ddc187c9d1e6ff27dd2c2093155ed0349ae0346c32e0ec003e5e2af20a4b454ffd6108c5bc1dafa01f0b9fe3fe2c  remove-daemon-directory.patch
c1c4235341381bcbd99574783d48e7e70fd554317c7bde854c1a256e4f72b273d8a7e3f9ed0095ae768412270b903b84bf478d82b1e51ac854bf3bb875d13485  upgrade-to-CXX-17.patch
"
