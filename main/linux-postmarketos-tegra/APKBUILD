_flavor=postmarketos-tegra
_config="config-$_flavor.$CARCH"
pkgname=linux-$_flavor
pkgver=5.9.0_git20200824
pkgrel=0
arch="aarch64"
pkgdesc="Kernel fork with Tegra patches"
url="https://github.com/grate-driver/linux"
license="GPL-2.0-only"
makedepends="devicepkg-dev perl sed installkernel bash gmp-dev bc linux-headers elfutils-dev openssl-dev file bison flex rsync xz"
options="!strip !check !tracedeps pmb:cross-native pmb:kconfigcheck-anbox"
_commit="9ad2a2ae7bbfa0b6a53fce1560869655cb5c64b0"
source="$pkgname-$_commit.tar.gz::https://github.com/MartijnBraam/linux-grate/archive/$_commit.tar.gz
	config-$_flavor.aarch64
	"

subpackages="$pkgname-dev"

_carch=$CARCH
case "$_carch" in
aarch64*) _carch="arm64" ;;
arm*) _carch="arm" ;;
ppc*) _carch="powerpc" ;;
s390*) _carch="s390" ;;
esac

builddir="$srcdir/linux-grate-$_commit"

prepare() {
	default_prepare

	REPLACE_GCCH=0 \
		. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-$_flavor" \
		CFLAGS_MODULE=-fno-pic
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor"

	make -j1 modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_DTBS_PATH="$pkgdir/usr/share/dtb"
}

dev() {
	provides="linux-headers"
	replaces="linux-headers"

	cd $builddir

	# https://github.com/torvalds/linux/blob/master/Documentation/kbuild/headers_install.rst
	make -j1 headers_install \
		ARCH="$_carch" \
		INSTALL_HDR_PATH="$subpkgdir"/usr
}

sha512sums="2c091616b51bf828192c3a49c0a3c3833a4afb4969caccec09aa30bd7597e6db02011e6e9f6e1914764904b99cf97a8105fc0eb00a8b9abf28b7c9d5f7c5a074  linux-postmarketos-tegra-9ad2a2ae7bbfa0b6a53fce1560869655cb5c64b0.tar.gz
cae0ffdc7abd470eff1637e5e5b06fc24c4aab0d032e351dff748f753112e360a7fa501e7fa42c95df58be049736db9cc73c19a740813c6bf88da525d6505a62  config-postmarketos-tegra.aarch64"
