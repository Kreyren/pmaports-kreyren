# Maintainer: Konrad Dybcio <konrad.dybcio@somainline.org>
# Kernel config based on: arch/arm64/configs/defconfig

_flavor="postmarketos-qcom-sdm660"
pkgname=linux-$_flavor
pkgver=5.9
pkgrel=0
pkgdesc="Mainline kernel fork for Qualcomm SDM630/636/660 devices"
arch="aarch64"
url="https://github.com/SoMainline/linux"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="bison findutils flex installkernel openssl-dev perl"

_carch="arm64"
# Source
_commit="v5.9-pmos-25102020"
source="
	$pkgname-$_commit.tar.gz::https://github.com/SoMainline/linux/archive/$_commit.tar.gz
	config-$_flavor.$arch
"
builddir="$srcdir/linux-${_commit#v}"

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$arch" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION=$((pkgrel + 1 ))
}

package() {
	# bootloader requires compressed kernel
	install -Dm644 "$builddir/arch/$_carch/boot/Image.gz" \
		"$pkgdir/boot/vmlinuz-$_flavor"

	install -D "$builddir/include/config/kernel.release" \
		"$pkgdir/usr/share/kernel/$_flavor/kernel.release"

	make modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_DTBS_PATH="$pkgdir/usr/share/dtb"
}
sha512sums="76308f9ddc402ddd4037d9157b7451ce4b4925f1716e5688b45ba144e544cd6d91ce13fc0b0897efae63f889e8897d4213d1ca93fc2d5b4afb2fb69ced1a3f41  linux-postmarketos-qcom-sdm660-v5.9-pmos-25102020.tar.gz
9f7245e8fe129ce5f5bee18c74d8c052fd698b0d436873ebc64a73a022d4855c73077b970589c4ee9b43ffb0464d4cef13fb236a7a13a8147e97cbb58fab514d  config-postmarketos-qcom-sdm660.aarch64"
