# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=osmscout-server
pkgver=2.0.0
pkgrel=0
_pkgver_geocoder_nlp=1.0.0
pkgdesc="Maps server providing tiles, geocoder, and router"
url="https://rinigus.github.io/osmscout-server"
# armhf blocked by kirigami2
# s390x and mips64 blocked by valhalla
arch="all !armhf !s390x !mips64"
license="GPL-3.0-or-later"
depends="kirigami2"
makedepends="
	bash
	date-dev
	kyotocabinet-dev
	libmarisa-dev
	libmicrohttpd-dev
	libpostal-dev
	qt5-qtbase-dev
	qt5-qtlocation-dev
	qt5-qtquickcontrols2-dev
	qt5-qttools-dev
	sqlite3pp
	valhalla-dev
	"
source="https://github.com/rinigus/osmscout-server/archive/$pkgver/osmscout-server-$pkgver.tar.gz
	https://github.com/rinigus/geocoder-nlp/archive/$_pkgver_geocoder_nlp/geocoder-nlp-$_pkgver_geocoder_nlp.tar.gz
	osmscout-server.desktop
	"

prepare() {
	default_prepare

	rmdir server/src/geocoder-nlp
	mv "$srcdir/geocoder-nlp-$_pkgver_geocoder_nlp" server/src/geocoder-nlp
}

build() {
	qmake-qt5 \
		PREFIX=/usr \
		CONFIG+=disable_osmscout \
		CONFIG+=disable_mapnik \
		CONFIG+=disable_systemd \
		SCOUT_FLAVOR=kirigami \
		VALHALLA_VERSION=3.1
	make
}

check() {
	make check
}

package() {
	make INSTALL_ROOT="$pkgdir" install

	install -Dm644 "$srcdir"/osmscout-server.desktop -t "$pkgdir"/etc/xdg/autostart/
}

sha512sums="7324cb31eed2c3cf01a7d11eaf995067b15ba84cf243ef70e1f6a028f2345692bd9823b94aa796d6409400bfd31f7b396e927094cb04e3991edae925a98d4c89  osmscout-server-2.0.0.tar.gz
c5edb82f2ef7d5917959fc99abfe53647cf01c972a4cac8da4549ab12cc5eca18b41ff1ea3e5dec3b16e6c8adc78bd118dd9e87b9a0c657a1876a38e48a3ed44  geocoder-nlp-1.0.0.tar.gz
cc0fe88824d23335a0cf80d89f1ace0405798e086b21f0cbf2cb24cb6436f38f843bdf12df07ee0bc32ba137f5dd7b6c04a377cf40cbdd872176302b8dce10f0  osmscout-server.desktop"
