# Contributor: Bart Ribbers <bribbers@disroot.org>
# Contributor: Rasmus Thomsen <oss@cogitri.dev>
# Maintainer: Antoine Fontaine <antoine.fontaine@epfl.ch>
# Forked from phosh to add patches
pkgname=swosh-shell
pkgver=0.3.1
pkgrel=0
pkgdesc="patched shell for swosh"
# Blocked on mips and s390x by gnome-session, gnome-settings-daemon, squeekboard and libhandy
# Blocked on ppc64le by gnome-session
arch="all !s390x !ppc64le !mips !mips64"
url="https://source.puri.sm/afontain/phosh"
license="GPL-3.0-only"
depends="wayland-protocols swosh-compositor gnome-session bash dbus-x11 gnome-settings-daemon
	squeekboard libpulse dbus:org.freedesktop.Secrets elogind gnome-control-center sway jq"
makedepends="gtk+3.0-dev meson ninja gnome-desktop-dev libhandy-dev gcr-dev upower-dev
	linux-pam-dev git cmake pulseaudio-dev networkmanager-dev polkit-elogind-dev
	libsecret-dev feedbackd-dev"
subpackages="$pkgname-lang"
source="
	$pkgname-$pkgver.tar.xz::https://repo.pureos.net/pureos/pool/main/p/phosh/phosh_$pkgver.tar.xz
	swosh.desktop
	sm.puri.SwoshOSK0.desktop
	0001-various-move-what-s-needed-so-it-doesn-t-conflict-wi.patch
	0002-home-add-action-buttons.patch
	0003-home-autohide-action-buttons-when-home-screen-is-ope.patch
	0004-ci-disable-gitlab-ci.patch
	0005-shell-fixup-screen-rotation.patch
	"

options="!check" # Needs a running Wayland compositor
builddir="$srcdir/phosh-$pkgver"

prepare() {
	default_prepare
}

build() {
	meson \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--buildtype=plain \
		. output
	ninja -C output
}

check() {
	ninja -C output test
}

package() {
	DESTDIR="$pkgdir/" ninja -C output install

	install -D -m644 "$srcdir"/swosh.desktop \
		"$pkgdir"/usr/share/wayland-sessions/swosh.desktop

	install -D -m644 "$srcdir"/sm.puri.SwoshOSK0.desktop \
		"$pkgdir"/usr/share/applications/sm.puri.SwoshOSK0.desktop
}
sha512sums="982f5e31298b97390a6b1e954626c768529c129105c3fd227115b5b3b933fdea3fcec6a19671a37b56cb5a5f8adf717c142a93cc87218abd224d2e18241d21ed  swosh-shell-0.3.1.tar.xz
7593e758f6161d36feeaba14b087746d14d5d8d7fd41ce6318867acb85198bb4c08041da25e096ffa8bc1b8e2e88db20726cb7199e919ad718d221c72298eb0e  swosh.desktop
f97019598323276cf97ae62f04b6245983198e04b228ddc605835ee46845d9b88c6890fb86e97e4bb6f1ad73361437d9ed18c91e81fe1284a88cdcb92d3fdc69  sm.puri.SwoshOSK0.desktop
c86d56a57b6954f932d9acb7e4073c05abca33fe776e5bbcc9412d4d899b33ec9a57abcc6309aacd4a2adb954836cc30e02dd9a4413fb16a8b4779c4bf24374f  0001-various-move-what-s-needed-so-it-doesn-t-conflict-wi.patch
04238e2aea13cb1966c69be6343ad0197e8e54d4a04c39e20a66cdf3b0b22a4a898d853b356e0dc5d6e89a98274905d9a9ba999cfce044282a17bb291668efb5  0002-home-add-action-buttons.patch
8ac136e4e643c1045b9203828671c4b6c00157df23a652e0f267b875a37888564605a3a63b6d531a1d51b6e9960e710dcbf489e1521bdd68bcaf44cf0e99ba44  0003-home-autohide-action-buttons-when-home-screen-is-ope.patch
647b80dcccb8c3e5c8c1f462117b217c0c0a226892d06a34c91befc6d2c0657f33ae2697f012f064a45e06e5cc748a69fad108fac668032a7549092a366b664b  0004-ci-disable-gitlab-ci.patch
2804b9da1f8d302b7e257feba7193f3a7ab99a0daaafe83d04c62243a722a59b18fa751e7331c944a71dc6ccf35eb370ca3390334b9a4f63fef6750f8034cc88  0005-shell-fixup-screen-rotation.patch"
