# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm/configs/(CHANGEME!)

pkgname=linux-samsung-gtexslte
pkgver=3.10.107
pkgrel=0
pkgdesc="Samsung Galaxy Tab A 7.0 (2016) kernel fork"
arch="armv7"
_carch="arm"
_flavor="samsung-gtexslte"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	dtbtool-sprd
	findutils
	flex
	gcc4
	linux-headers
	openssl-dev
	perl
"
if [ "${CC:0:5}" != "gcc4-" ]; then
	CC="gcc4-$CC"
	HOSTCC="gcc4-gcc"
	CROSS_COMPILE="gcc4-$CROSS_COMPILE"
fi
# Source
_repository="kernel_samsung_gtexslte"
_commit="b24143fbf786fa76740079098dbef57f990ca45e"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/smt285/$_repository/archive/$_commit.tar.gz
	$_config
	gcc8-fix-put-user.patch
	gcc10-extern_YYLOC_global_declaration.patch
	linux3.4-ARM-8933-1-replace-Sun-Solaris-style-flag-on-section.patch
	linux3.4-ARM-8933-1-replace-Sun-Solaris-style-flag-on-section-xz-supplementation.patch
	01_fix_piggy_junk_data.patch
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"

	# Master DTB (deviceinfo_bootimg_qcdt)
	dtbTool-sprd -p "$_outdir/scripts/dtc/" \
		-o "$_outdir/arch/$_carch/boot"/dt.img \
		"$_outdir/arch/$_carch/boot/dts/"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" \
		"$_flavor" "$_outdir"
	install -Dm644 "$_outdir/arch/$_carch/boot"/dt.img \
		"$pkgdir"/boot/dt.img
}

sha512sums="
e80b0dbc610df8d5feed995dd290764dfab9232fa21c684c5d1c937ed4c8f1677ffa60770bc0cc0db1484d6e43d7eff2f994d10f22c027db8f656fd4f6f2112b  linux-samsung-gtexslte-b24143fbf786fa76740079098dbef57f990ca45e.tar.gz
174903b204596df8fc30c4885854d04a15d1c9bfae6e5ca68283d3e4dd910877ec074ac0a14f44eda9c67278740178bc4cf34f996cd583812ce86d7fde4256be  config-samsung-gtexslte.armv7
197d40a214ada87fcb2dfc0ae4911704b9a93354b75179cd6b4aadbb627a37ec262cf516921c84a8b1806809b70a7b440cdc8310a4a55fca5d2c0baa988e3967  gcc8-fix-put-user.patch
2b48f1bf0e3f70703d2cdafc47d5e615cc7c56c70bec56b2e3297d3fa4a7a1321d649a8679614553dde8fe52ff1051dae38d5990e3744c9ca986d92187dcdbeb  gcc10-extern_YYLOC_global_declaration.patch
b14c0033045dd1ec5dd03612d8fb6361c4a0fa3eb54f7e262628d18756456c2e569a437d1b35099a8302577d1e471bbf9222b4b1b30f6578af7e4342a0009815  linux3.4-ARM-8933-1-replace-Sun-Solaris-style-flag-on-section.patch
a6b6c781dd23f9a45a1605456d8c9af3ec6b5c389acd2b5d4c32280dcb59118996d794165bea2005dbdd9415297e5060bcac7579f908f7d65406a862b743fed5  linux3.4-ARM-8933-1-replace-Sun-Solaris-style-flag-on-section-xz-supplementation.patch
ad32a9f75023c2d224cde8bc9a0cfa0f5792e7db703b232d1284935db397240f07773d320ca8898f11516dafda24b136c0504d6c8cf32551c5e8e87d246acc9a  01_fix_piggy_junk_data.patch
"
