From 1ceedf09d201485d42281fde9040f483e80ef3e9 Mon Sep 17 00:00:00 2001
From: Leandro Friedrich <email@leandrofriedrich.de>
Date: Fri, 21 Apr 2023 23:05:00 +0200
Subject: [PATCH] leo: add wifi

---
 ...com-msm8974pro-sony-xperia-shinano-leo.dts | 76 +++++++++++++++++++
 1 file changed, 76 insertions(+)

diff --git a/arch/arm/boot/dts/qcom-msm8974pro-sony-xperia-shinano-leo.dts b/arch/arm/boot/dts/qcom-msm8974pro-sony-xperia-shinano-leo.dts
index e18dbb217b0e..92d0dc297d71 100644
--- a/arch/arm/boot/dts/qcom-msm8974pro-sony-xperia-shinano-leo.dts
+++ b/arch/arm/boot/dts/qcom-msm8974pro-sony-xperia-shinano-leo.dts
@@ -58,6 +58,20 @@ key-volume-up {
 			wakeup-source;
 		};
 	};
+
+	vreg_wlan: wlan-regulator {
+		compatible = "regulator-fixed";
+
+		regulator-name = "wl-reg";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+
+		gpio = <&pm8941_gpios 18 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+
+		pinctrl-0 = <&wlan_regulator_pin>;
+		pinctrl-names = "default";
+	};
 };
 
 &blsp1_i2c6 {
@@ -121,6 +135,20 @@ gpio_keys_pin_a: gpio-keys-active-state {
 		bias-pull-up;
 		power-source = <PM8941_GPIO_S3>;
 	};
+
+	wlan_sleep_clk_pin: wl-sleep-clk {
+		pins = "gpio17";
+		function = "func2";
+		output-high;
+		power-source = <PM8941_GPIO_S3>;
+	};
+
+	wlan_regulator_pin: wl-reg-active {
+		pins = "gpio18";
+		function = "normal";
+		bias-disable;
+		power-source = <PM8941_GPIO_S3>;
+	};
 };
 
 &pm8941_lpg {
@@ -392,6 +420,28 @@ &sdhc_2 {
 	status = "okay";
 };
 
+&sdhc_3 {
+	max-frequency = <100000000>;
+	vmmc-supply = <&vreg_wlan>;
+	non-removable;
+
+	pinctrl-0 = <&sdhc3_pin_a>;
+	pinctrl-names = "default";
+
+	status = "okay";
+
+	wifi@1 {
+		compatible = "brcm,bcm4339-fmac", "brcm,bcm4329-fmac";
+		reg = <1>;
+
+		brcm,drive-strength = <10>;
+
+		pinctrl-0 = <&wlan_sleep_clk_pin>;
+		pinctrl-names = "default";
+	};
+};
+
+
 &smbb {
 	usb-charge-current-limit = <1500000>;
 	qcom,fast-charge-safe-current = <3000000>;
@@ -431,6 +481,32 @@ cmd-data-pins {
 		};
 	};
 
+	sdhc3_pin_a: sdhc3-pin-active {
+		clk {
+			pins = "gpio40";
+			function = "sdc3";
+
+			drive-strength = <10>;
+			bias-disable;
+		};
+
+		cmd {
+			pins = "gpio39";
+			function = "sdc3";
+
+			drive-strength = <10>;
+			bias-pull-up;
+		};
+
+		data {
+			pins = "gpio35", "gpio36", "gpio37", "gpio38";
+			function = "sdc3";
+
+			drive-strength = <10>;
+			bias-pull-up;
+		};
+	};
+
 	ts_int_pin: ts-int-pin-state {
 		pins = "gpio86";
 		function = "gpio";
-- 
2.40.1

