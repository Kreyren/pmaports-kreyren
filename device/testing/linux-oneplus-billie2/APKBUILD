# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/vendor/bengal_defconfig

# FIXME: this kernel doesn't build anymore!
# Once this is fixed, re-apply MR 3254: put dtbs in /boot.
# https://builds.sr.ht/~postmarketos/job/858910

pkgname=linux-oneplus-billie2
pkgver=4.19.152
pkgrel=0
pkgdesc="OnePlus Nord N100 kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="oneplus-billie2"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="bash bc bison devicepkg-dev flex openssl-dev perl linux-headers"

# Source
_repository="android_kernel_oneplus_sm4250"
_commit="c28f4e89d604c84cb147798bcebf0f7a0e54b432"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/OnePlusOSS/$_repository/archive/$_commit.tar.gz
	$_config
	0002-Fix-dangerous-relocation.patch
	0004-Fix-reading-after-array-end.patch
	0005-Remove-inline-from-external-functions.patch
	0006-Suppress-error-about-static-buffer-overflow.patch
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare

	mkdir -p "$builddir/$_outdir"
	cp "$srcdir/$_config" "$builddir"/"$_outdir"/.config
}

build() {
	unset LDFLAGS
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS" \
		CONFIG_SECTION_MISMATCH_WARN_ONLY=y
}

package() {
	KERNEL_IMAGE_NAME=Image.gz downstreamkernel_package \
		"$builddir" "$pkgdir" "$_carch" "$_flavor" "$_outdir"

	mkdir -p "$pkgdir/usr/share/dtb"
	install -Dm644 "$_outdir/arch/arm64/boot/dts/vendor/20882/bengal-qrd.dtb" \
		"$pkgdir/usr/share/dtb"

	make O="$_outdir" \
		ARCH="$_carch" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_MOD_PATH="$pkgdir" \
		modules_install
}

sha512sums="
29f48e1ce67d42afcaeccfba4e055d0c42526d507cedd00291fdf9fb72e4f464d6fc625c68a1edb9b4460e542b03f73d566f2372dec729d9aec84c9f4ff99956  linux-oneplus-billie2-c28f4e89d604c84cb147798bcebf0f7a0e54b432.tar.gz
53d5c7e98bcf0621f15e249393a610f685c9c9b20086dd1d463ce3d6c85df9bb7bed229ba65b80f0b28951ec174981613a48fad0c9d07228b0ae861eac8b98f7  config-oneplus-billie2.aarch64
39007dd285b502633c7bbf398acd6841a14fb6f5e0a3ad8570d31be77763b537b2352401701d67c53d36ddbf4068ee32446bf3b4ef9aa20c39f052ca491d2be4  0002-Fix-dangerous-relocation.patch
f8727c9c3b6c42ac921bd31fd05dc507e02a53c1c158fe7b67e75db482067b77ab9e2ffe33088c047a699b79642d6be1722d854cdf74cea6db5b46f586315bd0  0004-Fix-reading-after-array-end.patch
aba7ae12986a2df81c6993f369390c6b3f5586fa70ab747e03d59aaf08cb79482a44eab723aed4469e98cadea0f70912f4e67caaf67cc279e1dc85e485b93a0f  0005-Remove-inline-from-external-functions.patch
3835f7e4fca12aaba82fe21cc9632f0e569a8c4405231d137aea4f2640190d919e1a44612082decfbaaa41faa3c6a3ff0442086afb81d59c984a5697fdb9cac9  0006-Suppress-error-about-static-buffer-overflow.patch
"
