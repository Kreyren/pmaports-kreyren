
# Reference: <https://postmarketos.org/devicepkg>
# Maintainer: Caleb Connolly <caleb@connolly.tech>

pkgname=device-generic-sdm845
pkgdesc="SDM845 generic device port (for use with u-boot)"
pkgver=1
pkgrel=0
url="https://postmarketos.org"
license="MIT"
arch="aarch64"
# pmb:strict is required for grub
options="!check !archcheck pmb:strict"
depends="
	linux-postmarketos-qcom-sdm845
	make-dynpart-mappings
	mkbootimg
	postmarketos-base
	postmarketos-update-kernel
	soc-qcom-sdm845
	soc-qcom-sdm845-ucm
	soc-qcom-sdm845-qbootctl
	u-boot-sdm845
	fwupd>=1.8.6
"
makedepends="devicepkg-dev grub grub-efi"
source="
	deviceinfo
	q6voiced.conf
	modules-initfs
"
subpackages="$pkgname-nonfree-firmware:nonfree_firmware"

build() {
	devicepkg_build $startdir $pkgname

	grub-mkimage \
		--prefix="/grub" \
		--output="bootaa64.efi" \
		--format="arm64-efi" \
		--compression="xz" \
		\
		all_video \
		cat \
		configfile \
		disk \
		echo \
		efi_gop \
		fat \
		gzio \
		help \
		iso9660 \
		linux \
		ls \
		normal \
		part_gpt \
		part_msdos \
		search \
		search_label \
		test \
		true
}

package() {
	devicepkg_package $startdir $pkgname

	install -Dm644 -t "$pkgdir"/boot/EFI/Boot \
		"$srcdir"/bootaa64.efi
}

nonfree_firmware() {
	pkgdesc="Modem, GPU and WiFi Firmware, also needed for osk-sdl"
	depends="firmware-shift-sdm845 firmware-shift-sdm845-initramfs
		 firmware-oneplus-sdm845 firmware-oneplus-sdm845-initramfs
		 firmware-xiaomi-beryllium
		 soc-qcom-sdm845-nonfree-firmware soc-qcom-sdm845-modem"
	mkdir "$subpkgdir"

	install -Dm644 q6voiced.conf "$subpkgdir"/etc/conf.d/q6voiced
}

sha512sums="
641ded402aa97bb1f9f7e837b2210d9fb9b8edaf98ad464ca2c92a0325694fb2fd456e42298c3a50bee895eafa908b07e46ebc8def391b4291c42ac178dea6a6  deviceinfo
2131a6838a7af24ff91de24064d27b0e43706831701fff5e8d6827d808d3ddaa74cd68f9d6575204df86af237224807aadc014a43f5600f1adc95408da6f273a  q6voiced.conf
84ec48c6adf5644d6b8b848d18e35383fe0d5bbf17045112a76f6d285f9938d8874836ceca724d3eb8a61b10395b4b9365888c81c83480e2f26a76afecd702ed  modules-initfs
"
