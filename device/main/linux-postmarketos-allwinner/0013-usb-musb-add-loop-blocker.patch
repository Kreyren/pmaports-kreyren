From 95bd3825a43f2248c19a3eee6ca78e707d53a614 Mon Sep 17 00:00:00 2001
From: Ondrej Jirman <megi@xff.cz>
Date: Thu, 31 Mar 2022 20:59:28 +0200
Subject: [PATCH 1/4] usb: musb: add loop blocker

Signed-off-by: Ondrej Jirman <megi@xff.cz>
---
 drivers/usb/musb/musb_host.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/drivers/usb/musb/musb_host.c b/drivers/usb/musb/musb_host.c
index 9ff7d891b4b76..b22792f48140a 100644
--- a/drivers/usb/musb/musb_host.c
+++ b/drivers/usb/musb/musb_host.c
@@ -2488,6 +2488,8 @@ static void musb_h_stop(struct usb_hcd *hcd)
 	hcd->state = HC_STATE_HALT;
 }
 
+static int loop_limit;
+
 static int musb_bus_suspend(struct usb_hcd *hcd)
 {
 	struct musb	*musb = hcd_to_musb(hcd);
@@ -2520,6 +2522,16 @@ static int musb_bus_suspend(struct usb_hcd *hcd)
 	if (musb->is_active) {
 		WARNING("trying to suspend as %s while active\n",
 				usb_otg_state_string(musb->xceiv->otg->state));
+
+		// the code here tends to loop in some situations, prevent
+		// endless loop by reporting success after 20 failures
+		if (loop_limit < 20) {
+			loop_limit++;
+		} else {
+			WARNING("loop prevented\n");
+			return 0;
+		}
+
 		return -EBUSY;
 	} else
 		return 0;
-- 
2.35.1

