# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm/configs/odroidxu4_defconfig
# Maintainer: Dylan Van Assche <me@dylanvanassche.be>

pkgname=linux-odroid-hc2
pkgver=5.15.7
pkgrel=2
pkgdesc="ODROID XU3/XU4/HC1/HC2/MC1 kernel fork"
arch="armv7"
_carch="arm"
_flavor="odroid-hc2"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native pmb:kconfigcheck-nftables"
makedepends="
	bison
	devicepkg-dev
	findutils
	flex
	gmp-dev
	installkernel
	mpc1-dev
	mpfr-dev
	openssl-dev
	perl
	rsync
	xz
	linux-headers
	"
# Source
_config="config-$_flavor.$arch"
_pkgname="linux"
_commit="77ebfca65d59167038ef5fcc62d2e8d49f47fa49"
source="
	$_pkgname-$pkgver.tar.gz::https://github.com/tobetter/linux/archive/$_commit.tar.gz
	$_config
	cve-2021-39685-usb-gadget-buffer-overflow-fix-1.patch
	cve-2021-39685-usb-gadget-buffer-overflow-fix-2.patch
	cve-2022-0847-dirty-pipe.patch
"
subpackages="$pkgname-dev"
builddir="$srcdir/$_pkgname-$_commit"

prepare() {
	default_prepare
	REPLACE_GCCH=0 \
		. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor" "$_outdir"

	make modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_DTBS_PATH="$pkgdir/usr/share/dtb"
}

dev() {
	provides="linux-headers"
	replaces="linux-headers"

	cd $builddir

	# https://github.com/torvalds/linux/blob/master/Documentation/kbuild/headers_install.rst
	make -j1 headers_install \
		ARCH="$_carch" \
		INSTALL_HDR_PATH="$subpkgdir"/usr
}

sha512sums="
7a377c6afcb5d62f223c909709ab22644ee4345dafa348cc9293d58bd9251b5c77e4be894a2b6238c2cb3478d6430d0e45dd1de918468a9f038514e47f234197  linux-5.15.7.tar.gz
bf3e599de30d88ab9c0df3e7a9487bf9aa0b511615208c82a1c7f2fc254839a896637effa3bb49a7081eded25168aa3aa5855feb516b935d33f106995cffbfba  config-odroid-hc2.armv7
ec2afe591b78adbecbd8eb3de08d0601136849d98a3ef14e748a086970810d33a6e11f3ae6e4e501a6c9915b17d957f3827611527151a78faec9de04dfa1b365  cve-2021-39685-usb-gadget-buffer-overflow-fix-1.patch
b3bc4d99479f943c09c93ad2662f9ffc8bb852a668562704538403a9a7326cde73c146521ab7e76a3f565eab8f6c88820189d8ba677373e62dce31f1e43141c8  cve-2021-39685-usb-gadget-buffer-overflow-fix-2.patch
bfba2e4a4ac9639dc1a3aa0d4779748b62c8efaf8a533e30a4431571115d4356e6e54e00d2508928405ce3607e63aba61a9bad7a0f1712b46ff5706589ccbbfa  cve-2022-0847-dirty-pipe.patch
"
