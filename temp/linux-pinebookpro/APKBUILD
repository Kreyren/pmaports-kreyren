# Temporary kernel with a patch for the Pinebook Pro, can be removed once Alpine switches linux-edge to 5.9.1 and has this patch in it.
pkgname=linux-pinebookpro
pkgver=5.9.0
pkgrel=0
pkgdesc="Kernel fork with Pinebook Pro patches"
arch="aarch64"
_carch="arm64"
_flavor="pinebookpro"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="devicepkg-dev perl sed bash gmp-dev bc linux-headers elfutils-dev openssl-dev file bison flex rsync"

# Source
_config="config-$_flavor.$arch"
source="
	https://git.kernel.org/torvalds/t/linux-5.9.tar.gz
	config-pinebookpro.aarch64
	keep-enabled-pwms-running-while-probing.patch
"
builddir="$srcdir/linux-5.9"

prepare() {
	default_prepare
	REPLACE_GCCH=0 \
		. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-$_flavor" \
		CFLAGS_MODULE=-fno-pic
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor"

	make -j1 modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_DTBS_PATH="$pkgdir/usr/share/dtb"
}

sha512sums="01a2078303d432ae2f5ad130f78697d24f77ac60e50171a809f917c275293d06d13250073a5799ba155771915a10195008459cfa1825d4ab7f2cc24cfb320fa5  linux-5.9.tar.gz
e5e38377f5cfe89e5a0145e1f321c0e1eb8b6264090fea760d3efe597815303fe813ea1cafcc9583a89be2357db6e0c39b1b7b81e9bebf448e44517f468eaf21  config-pinebookpro.aarch64
3a3141f63197dd6916b85aeabd0aecedf82d4623d33164a13336d04d26654ad2e6ee9279c69a55f4dd374ec88f22be113795106e94a15957309e177d235f810f  keep-enabled-pwms-running-while-probing.patch"
