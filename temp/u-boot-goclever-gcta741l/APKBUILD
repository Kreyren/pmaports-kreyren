# Maintainer Jacek Pruciak <pmos@juniorjpdj.pl>
# Forked from Alpine, add external boards
pkgname=u-boot-goclever-gcta741l
pkgver=2021.01
pkgrel=0
pkgdesc="u-boot for goclever-gcta741l"
url="https://www.denx.de/wiki/U-Boot/"
arch="armv7"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
options="!check" # no tests in upstream
makedepends="$depends_dev bc dtc python3-dev swig bison flex openssl-dev
	py3-setuptools linux-headers"
# https://github.com/megous/linux/tree/orange-pi-5.12#kernel-lockup-issues
source="
	https://ftp.denx.de/pub/u-boot/u-boot-${pkgver//_/-}.tar.bz2
	0001-sunxi-h3-Fix-PLL1-setup-to-never-use-dividers.patch
	add-dtbs-to-makefile.patch
	sun4i-a10-lark-freeme-70-2s.dts
	sun5i-a13-prestigio-per5574bc.dts
	sun6i-a31s-goclever-gcta741l.dts
	goclever-gcta741l_defconfig
	lark-freeme-70-2s_defconfig
	prestigio-per5574bc_defconfig
	"
builddir="$srcdir"/u-boot-${pkgver//_/-}

board_configs="
	prestigio-per5574bc:prestigio-per5574bc
	lark-freeme-70-2s:lark-freeme-70-2s
	"

subpackages=""
for board_config in $board_configs; do
	_board="${board_config%%:*}"
	subpackages="$subpackages u-boot-$_board:${_board//-/_}"
done

prepare() {
	default_prepare

	cp "$srcdir"/*.dts "$builddir"/arch/arm/dts/
	cp "$srcdir"/*_defconfig "$builddir"/configs/
}

build() {
	cd "$builddir"
	touch include/config.h
	LC_ALL=C date +'#define U_BOOT_DATE "%b %d %C%y"' > include/timestamp_autogenerated.h
	LC_ALL=C date +'#define U_BOOT_TIME "%T"' >> include/timestamp_autogenerated.h

	local board_config board
	for board_config in "goclever-gcta741l:goclever-gcta741l" $board_configs; do
		local configs="${board_config#*:}"
		for board in ${configs//,/ }; do
			msg "Building u-boot for $board"

			export BUILD_DIR="$builddir"/build/$board
			mkdir -p "$BUILD_DIR"
			make O="$BUILD_DIR" ${board}_config || return 1
			make O="$BUILD_DIR" all || return 1
		done
	done
	msg "Building u-boot-tools"
	make tools-only_defconfig
	make tools-all
}


_split_boards() {
	cd "$builddir"/build
	pkgdesc="u-boot for $1"
	depends=""
	shift
	local board
	for board; do
		msg "Including board $board"
		mkdir -p "$subpkgdir"/usr/share/u-boot/$board
		export BUILD_DIR="$builddir"/build/$board
		local ok=no
		for image in u-boot-sunxi-with-spl.bin -- MLO SPL u-boot.img -- u-boot.bin; do
			if [ "$image" = "--" ]; then
				[ "$ok" = yes ] && break
				continue
			fi
			if [ -e "$BUILD_DIR"/$image ]; then
				cp "$BUILD_DIR"/$image "$subpkgdir"/usr/share/u-boot/$board \
					|| return 1
				ok=yes
			fi
		done
		[ "$ok" = yes ] || return 1
	done
}

package() {
	_board="goclever-gcta741l"
	_configs="goclever-gcta741l"
	export subpkgdir="$pkgdir"

	_split_boards $_board ${_configs//,/ }
}

for board_config in $board_configs; do
	_board="${board_config%%:*}"
	_configs="${board_config#*:}"
	eval "${_board//-/_}() { _split_boards $_board ${_configs//,/ }; }"
done

sha512sums="40dd4d9ef87a1829158658c433d46a047a39c0d8c314ad8d133f7240343ee3a75b060f009dd2efe598cfb8a766773f6cd773ea7f7745ee88e52a771c77eb1c6e  u-boot-2021.01.tar.bz2
9478a5b46414139212a11d29e05dd973c4c866e8970b25021517d47b7177a03c910dbe761ae9c5acee0e4f1a5a8db76f24e168b83a5ebd9034d9cb640350604e  0001-sunxi-h3-Fix-PLL1-setup-to-never-use-dividers.patch
37808f4c2651405b848f3072ebd6355db46e3b36d616763317d3e2f35e848aaeca34de05c57150742db018054c4661d71be6df1276c3d34171d6c758ff1a3698  add-dtbs-to-makefile.patch
205966445a09c391945fc0d93ff97297f75782ac57df65c23e2ae8076f0341370031d028d07c39235dfd81fe7e340c19c3ce0ab7594d6a3cd81622683c97db6a  sun4i-a10-lark-freeme-70-2s.dts
4913803d7d0e9a97ff75ce3b3c791c89e450beb8320cc8354f8af172af7648823b4b20e3d068662080934351211232fb0827e76124461d4de9f74335c640dcc3  sun5i-a13-prestigio-per5574bc.dts
63ee02f1791c1cc388495bfac87a2b30565d8b70970fa4aa890c3a9edf0fabfb3245895378b269446ba1dd32808f9c2dde416b0bc857c10969023bda5d94770d  sun6i-a31s-goclever-gcta741l.dts
b66b916360aae9af41ef161a854420f8dffefc5d50dca833366fed2a6d9cf7509ee12baffd87cd78af1dc350b42fcde80c12e4ed4c92990e0821e656192ad0f6  goclever-gcta741l_defconfig
73d6bfc743c893d295c46b6a2ebcf7fb07f57bf776158e3a41c715d47b8e9890bf9037bdc654ee65b90f7b1596428fb63229264e2d1176ca725d6cc0fc95e6b2  lark-freeme-70-2s_defconfig
b16feabad9944c0ae52394478ccf45034226c7e619f8bf97d8096577291567a6328a70ee9f590e8b260a7f83fad0cbfe12f4b9ff55e8697b52ca264fdbca7395  prestigio-per5574bc_defconfig"
