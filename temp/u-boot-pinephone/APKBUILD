# U-boot with patches to make the PinePhone boot faster and have control over the ddr clock speed
pkgname=u-boot-pinephone
pkgver=2021.04
pkgrel=0
pkgdesc="U-Boot bootloader for the PINE64 PinePhone"
url="https://source.denx.de/u-boot"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
depends="linux-postmarketos-allwinner>=5.12"
makedepends="$depends_dev bc dtc python3-dev py3-setuptools swig bison flex openssl-dev arm-trusted-firmware-sun50i crust"
options="!check"
source="http://source.denx.de/u-boot/u-boot/-/archive/v$pkgver/u-boot-v$pkgver.tar.gz
	0001-sunxi-support-asymmetric-dual-rank-DRAM-on-A64-R40.patch
	0002-sunxi-pinephone-Add-support-for-optional-LED-feedbac.patch
	0003-dts-add-WiFi-to-pinephone-dts.patch
	0004-common-expose-DRAM-clock-speed.patch
	0005-configs-pinephone-review.patch
	0006-mmc-sunxi-Add-support-for-DMA-transfers.patch
	0007-mmc-sunxi-DDR-DMA-support-for-SPL.patch
	0008-spl-ARM-Enable-CPU-caches.patch
	update-u-boot
	"
builddir="$srcdir/u-boot-v$pkgver"
install="$pkgname.post-upgrade"
frequencies='528 552 624'

build() {
	touch include/config.h
	LC_ALL=C date +'#define U_BOOT_DATE "%b %d %C%y"' > include/timestamp_autogenerated.h
	LC_ALL=C date +'#define U_BOOT_TIME "%T"' >> include/timestamp_autogenerated.h

	export BL31="/usr/share/arm-trusted-firmware-sun50i/bl31.bin"
	export SCP="/usr/share/crust/pinephone/scp.bin"
	export BUILD_DIR="$builddir"/build
	
	for freq in $frequencies; do
		mkdir -p "$BUILD_DIR-$freq"
		sed -rie "s/^(CONFIG_DRAM_CLK=).*$/CONFIG_DRAM_CLK=$freq/" configs/pinephone_defconfig
		cat configs/pinephone_defconfig | grep CONFIG_DRAM_CLK
		make O="$BUILD_DIR-$freq" HOSTCC=gcc ARCH=arm pinephone_defconfig
		make O="$BUILD_DIR-$freq" HOSTCC=gcc ARCH=arm all
		sha512sum -b "$BUILD_DIR-$freq/u-boot-sunxi-with-spl.bin" > "$BUILD_DIR-$freq/u-boot-sunxi-with-spl.bin.sha512"
	done
}

package() {
	for freq in $frequencies; do
		install -D -m644 "build-$freq/u-boot-sunxi-with-spl.bin" \
			"$pkgdir/usr/share/u-boot/pine64-pinephone/u-boot-sunxi-with-spl-$freq.bin"
		install -D -m644 "build-$freq/u-boot-sunxi-with-spl.bin.sha512" \
			"$pkgdir/usr/share/u-boot/pine64-pinephone/u-boot-sunxi-with-spl-$freq.bin.sha512"
	done
	install -D -m 755 "$srcdir"/update-u-boot "$pkgdir"/usr/sbin/update-u-boot
}

sha512sums="
433dab917b4bbc2be2e5c79b46a88170b11ef2e2f5d0c56e79da5ff248ac1aa94e54f7ea51b38e08d982f44764209b9b076416d2a3a708b2128fb6356eb2df73  u-boot-v2021.04.tar.gz
f665b664f91a33507a8bc24a1e2e731a029f7813df74a530837e1e51d28c3ad898bdc986083e18bfa4403aec4d46c724dac97a4cf1b4daa0c9d39bbddd719b68  0001-sunxi-support-asymmetric-dual-rank-DRAM-on-A64-R40.patch
285f56223c0da0060be544fc0b96b9fbb048453e3ba22841021ecde6c44ecb1284285b228368a07ad42480c01a7435668ebf5e5377f90bdce5b1b273707e6b6c  0002-sunxi-pinephone-Add-support-for-optional-LED-feedbac.patch
84dd5d7fe86f91cdacb79c87d1057cc7e4008f600da75ae43ed59d4d9a19b604db87526362096dd78284f5030220df04680a84fd84ec2f474e8b0a456a1a9443  0003-dts-add-WiFi-to-pinephone-dts.patch
86d9587cb2b0ca99fb4090bd0daacd47c0043858654f6f7114c8d0ed6c660eb2b8bc0b37de6723e738df9b1137d62482f00764c284f4aa0a6054db9efe754db9  0004-common-expose-DRAM-clock-speed.patch
44590530c93f74758d74857ef5a261e2764f88086e40276abc3140a4d39bc563381d0a43055deb08ceefcbbe7eeeb24a9b7875180aad82fe8ac00035841dddb6  0005-configs-pinephone-review.patch
c39a20b76bae4c7bb03f185a5a7c90f9842c4487a51f9b1695c80cadadce6cc0228060d602443cf561559f9ca7ad6422f1615fc9ceaf241349e9a32ba8bcfafc  0006-mmc-sunxi-Add-support-for-DMA-transfers.patch
86bbe7b3eca8a041eb7b0cfdd8b9385fc03a4c723d55341fa58049409694d3f9cbd9f6a9a4c4f26f182b248ce8800a7e88921c9b6202a3f65857d6dca6217702  0007-mmc-sunxi-DDR-DMA-support-for-SPL.patch
b3338e7fa9a59dd21b7c3c6ee5d5131d47d5d2f60c3cbba79b611e30342eb215725db5cec477b9eeb62cc7a75cdf868f83b1406c70c43535d14412e43f1747ac  0008-spl-ARM-Enable-CPU-caches.patch
4857d5f6e4f591f97b8842cc9fb7d1131d71af63d05f6bd8457f4323886fb2334614a00699a3efc8d1b32d149d130c3cca0205150eedb40e9da60e4508281e36  update-u-boot
"
