# U-boot with patches to make the PinePhone boot faster and have control over the ddr clock speed

pkgname=u-boot-pinephone
pkgver=2020.04_git20200421
pkgrel=0
_commit="e813d3d71d0edf1f1522ccfd1e689d35f3e9a0f6"
pkgdesc="u-boot bootloader for the PINE64 PinePhone"
url="https://gitlab.com/pine64-org/u-boot"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
makedepends="$depends_dev bc dtc python3-dev swig bison flex openssl-dev arm-trusted-firmware-sun50i"
options="!check"
source="
	$pkgname-$_commit.tar.gz::https://gitlab.com/pine64-org/u-boot/-/archive/$_commit/u-boot-$_commit.tar.gz
	dram-speed.patch
	"
builddir="$srcdir"/u-boot-$_commit

build() {
	touch include/config.h
	LC_ALL=C date +'#define U_BOOT_DATE "%b %d %C%y"' > include/timestamp_autogenerated.h
	LC_ALL=C date +'#define U_BOOT_TIME "%T"' >> include/timestamp_autogenerated.h

	export BL31="/usr/share/arm-trusted-firmware-sun50i/bl31.bin"
	export BUILD_DIR="$builddir"/build
	mkdir -p "$BUILD_DIR"
	make O="$BUILD_DIR" HOSTCC=gcc ARCH=arm pinephone_defconfig
	make O="$BUILD_DIR" HOSTCC=gcc ARCH=arm all
}

package() {
	cd "$builddir"/build
	install -D -m644 "u-boot-sunxi-with-spl.bin" \
		"$pkgdir"/usr/share/u-boot/pine64-pinephone/u-boot-sunxi-with-spl.bin
}


sha512sums="afcd9409713bc46cb978641d8c64f5fbee992c89520e7f2626a3a9a8d61837c78bbf4bf3fc6ea5e468cafaeeda9c532b64e154fec7c9f4032783eca97e113ac7  u-boot-pinephone-e813d3d71d0edf1f1522ccfd1e689d35f3e9a0f6.tar.gz
0331e05f9077eb4c8219b5fa804a8372a0ca20957cacfdff618d2045f64949581418aef4dfef2e87c31ca218c9ac22e20cf8021b679c5fa7cfb9f89876da02fa  dram-speed.patch"
